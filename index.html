<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>9×9 正方形提子棋</title>
  <style>
    :root{
      /* 稍微提高背景亮度 */
      --bg:#101a33;
      --panel:#0f1a33;
      --line:#1f2a44;
      --text:#e8eefc;
      --muted:#a9b6d6;
      --black:#0b0b0b;
      --white:#f2f2f2;
      --accent:#6aa9ff;
      --danger:#ff6a7a;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, #223a7a 0%, var(--bg) 55%),
        radial-gradient(900px 700px at 85% 15%, rgba(106,169,255,.18) 0%, rgba(0,0,0,0) 55%);
      color:var(--text);
    }
    .wrap{
      max-width:1100px; margin:24px auto; padding:0 16px;
      display:grid; gap:16px; grid-template-columns: 1fr 320px;
    }
    .card{
      background:rgba(15,26,51,.88);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      box-shadow: 0 12px 32px rgba(0,0,0,.35);
    }
    .boardCard{ padding:16px; }
    .side{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    h1{ font-size:18px; margin:0 0 8px 0; letter-spacing:.5px; }
    .sub{ color:var(--muted); font-size:13px; line-height:1.5; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px;
      border-radius:999px; background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10); font-size:13px;
    }
    .dot{ width:10px; height:10px; border-radius:50%; }
    .dot.black{ background:var(--black); box-shadow:0 0 0 2px rgba(255,255,255,.15) inset; }
    .dot.white{ background:var(--white); box-shadow:0 0 0 2px rgba(0,0,0,.18) inset; }
    .dot.phase{ background:var(--accent); }
    .scoreRow{ display:flex; gap:8px; flex-wrap:wrap; }

    .board{
      width:min(78vmin, 620px);
      aspect-ratio:1/1;
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(9, 1fr);
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(0deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    }
    .cell{
      position:relative;
      border:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
    }
    .cell:hover{ background: rgba(106,169,255,.10); }
    .cell.disabled{ cursor:not-allowed; opacity:.78; }

    .stone{
      width:70%; height:70%;
      border-radius:50%;
      transform: translateZ(0);
      box-shadow: 0 10px 16px rgba(0,0,0,.35);
      position:relative;
      z-index: 1;
    }
    .stone.black{
      background: radial-gradient(circle at 30% 30%, #2a2a2a 0%, var(--black) 65%);
      outline: 1px solid rgba(255,255,255,.08);
    }
    .stone.white{
      background: radial-gradient(circle at 30% 30%, #ffffff 0%, var(--white) 65%);
      outline: 1px solid rgba(0,0,0,.10);
    }

    /* 標示落子處：實心標記（疊在棋子/格子上方） */
    .cell.lastmove::after{
      content:"";
      position:absolute;
      width:10px; height:10px;
      border-radius:50%;
      background: rgba(255, 215, 102, .95);
      box-shadow: 0 0 0 2px rgba(0,0,0,.35);
      z-index: 3;
      top:50%; left:50%;
      transform: translate(-50%,-50%);
      pointer-events:none;
    }

    /* 標示提正方形四角：空心標記 */
    .cell.sqcorner::before{
      content:"";
      position:absolute;
      width:22px; height:22px;
      border-radius:50%;
      border: 2px solid rgba(106,169,255,.95);
      box-shadow: 0 0 0 2px rgba(0,0,0,.22) inset;
      z-index: 2;
      top:50%; left:50%;
      transform: translate(-50%,-50%);
      pointer-events:none;
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:disabled{ opacity:.45; cursor:not-allowed; }
    .primary{ border-color: rgba(106,169,255,.45); background: rgba(106,169,255,.16); }
    .primary:hover{ background: rgba(106,169,255,.22); }
    .danger{ border-color: rgba(255,106,122,.45); background: rgba(255,106,122,.14); }
    .danger:hover{ background: rgba(255,106,122,.20); }

    .list{
      max-height:260px;
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .item{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:13px;
      cursor:pointer;
    }
    .item:last-child{ border-bottom:none; }
    .item:hover{ background: rgba(255,255,255,.06); }
    .item.sel{ background: rgba(106,169,255,.18); border-bottom-color: rgba(106,169,255,.25); }
    .badge{
      font-size:12px; color:var(--muted);
      padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }

    .log{
      font-size:13px; line-height:1.5;
      color: var(--muted);
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      padding:10px;
      min-height:92px;
      white-space:pre-wrap;
    }

    .footerHint{ color:var(--muted); font-size:12px; line-height:1.5; }
    @media (max-width: 920px){
      .wrap{ grid-template-columns: 1fr; }
      .board{ width:min(92vmin, 620px); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card boardCard">
      <div class="topbar">
        <div>
          <h1>9×9 正方形提子棋 v1.3</h1>
          <div class="sub">黑棋先行（玩家＝黑），白棋為智慧 CPU。每回合：下棋 →（若可提子則必須提子）→ 結束回合。</div>
        </div>
        <div class="scoreRow">
          <div class="pill" id="turnPill"><span class="dot black" id="turnDot"></span><span id="turnText">黑方回合</span></div>
          <div class="pill"><span class="dot phase"></span><span id="phaseText">下棋階段</span></div>
          <div class="pill"><span>黑分：</span><b id="scoreB">0</b></div>
          <div class="pill"><span>白分：</span><b id="scoreW">0</b></div>
          <div class="pill"><span>目標：</span><b>81</b></div>
        </div>
      </div>

      <div class="board" id="board"></div>
    </div>

    <div class="card side">
      <div class="sub">
        <b>提子規則：</b>提子階段，若「當前玩家的任四顆棋」能形成正方形（斜的也算），即可將「這四顆自己的棋」提掉，並獲得該正方形面積分數（= 邊長²）。<br>
        <b>強制提子：</b>若存在可用正方形，本回合必須提子（可選要提哪一個正方形）。
      </div>

      <div>
        <div class="pill" style="width:100%; justify-content:space-between;">
          <span>可用正方形</span>
          <span class="badge" id="sqCount">0</span>
        </div>
        <div class="list" id="sqList"></div>
      </div>

      <div class="btnRow">
        <button class="primary" id="btnCaptureSquare">提子（移除4子）</button>
        <button class="primary" id="btnSkipCapture">跳過提子</button>
        <button class="primary" id="btnEndTurn">結束回合 →</button>
        <button class="danger" id="btnRestart">重新開始</button>
      </div>

      <div class="log" id="log"></div>

      <div class="footerHint">
        標記說明：<br>
        ● 實心點＝上一步落子位置<br>
        ○ 空心圈＝目前選中的正方形四角<br><br>
        操作提示：<br>
        1) 下棋階段：點空格下 1 顆。<br>
        2) 若可提子：先在右側選正方形（會以空心圈標四角），按「提子」得分。<br>
        3) 若無可提子：可直接結束回合。
      </div>
    </div>
  </div>

<script>
(() => {
  const N = 9;
  const TARGET = 81;

  // board[y][x] = 0 empty, 1 black, 2 white
  let board = Array.from({length:N}, () => Array(N).fill(0));
  let turn = 1; // 1 black, 2 white
  let phase = "place"; // "place" | "capture"
  let placedThisTurn = false;

  let scoreB = 0, scoreW = 0;

  // capture UI state
  let availableSquares = []; // {cells:[{x,y}..4], area, key}
  let selectedSquareKey = null;
  let captureDoneThisTurn = false;

  // last move marker
  let lastMove = null; // {x,y}

  // DOM
  const elBoard = document.getElementById("board");
  const elPhaseText = document.getElementById("phaseText");
  const elTurnText = document.getElementById("turnText");
  const elTurnDot  = document.getElementById("turnDot");
  const elScoreB = document.getElementById("scoreB");
  const elScoreW = document.getElementById("scoreW");
  const elSqList = document.getElementById("sqList");
  const elSqCount = document.getElementById("sqCount");
  const elLog = document.getElementById("log");
  const btnSkipCapture = document.getElementById("btnSkipCapture");
  const btnEndTurn = document.getElementById("btnEndTurn");
  const btnRestart = document.getElementById("btnRestart");
  const btnCaptureSquare = document.getElementById("btnCaptureSquare");

  // build grid
  const cellEls = Array.from({length:N}, () => Array(N).fill(null));
  for (let y=0; y<N; y++){
    for (let x=0; x<N; x++){
      const d = document.createElement("div");
      d.className = "cell";
      d.dataset.x = x;
      d.dataset.y = y;
      d.addEventListener("click", () => onCellClick(x,y));
      elBoard.appendChild(d);
      cellEls[y][x] = d;
    }
  }

  btnSkipCapture.addEventListener("click", () => {
    if (phase !== "capture") return;
    if (turn === 2) return;
    // 強制提子：若有可用正方形，不允許跳過
    if (availableSquares.length > 0) {
      logLine("此回合存在可用正方形，必須提子（可選要提哪個）。");
      return;
    }
    captureDoneThisTurn = true;
    selectedSquareKey = null;
    clearSquareMarkers();
    renderSquares([]);
    logLine(`${turnName(turn)} 跳過提子。`);
    updateButtons();
  });

  btnCaptureSquare.addEventListener("click", () => {
    if (phase !== "capture") return;
    if (turn === 2) return; // CPU 自己會做
    if (captureDoneThisTurn) return;

    if (availableSquares.length === 0) {
      logLine("目前沒有可用正方形，無法提子。");
      return;
    }
    if (!selectedSquareKey) {
      logLine("請先在右側選一個正方形。");
      return;
    }

    const sq = availableSquares.find(s => s.key === selectedSquareKey);
    if (!sq) return;

    // 移除自己形成正方形的四顆棋
    sq.cells.forEach(c => {
      if (board[c.y][c.x] === turn) board[c.y][c.x] = 0;
    });

    // 得分
    addScore(turn, sq.area);

    captureDoneThisTurn = true;
    logLine(`${turnName(turn)} 提子：移除自己 4 子（面積 ${sq.area}），得分 +${sq.area}。`);

    selectedSquareKey = null;
    clearSquareMarkers();
    renderAll();
    checkWinMaybe();
  });

  btnEndTurn.add
